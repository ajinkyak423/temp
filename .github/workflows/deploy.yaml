name: summon-platform-CI

on:
  push:
  workflow_dispatch:

    
jobs:
  Build-docker-image:
    name: docker_image
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8.15'

      - name: check for deploy
        if: contains(github.event.head_commit.message, 'deploy')
        run: |
          DEPLOY=$(echo "${{ github.event.head_commit.message }}" | sed -n 's/.*\[deploy:[[:space:]]*\([^]]*\)].*/\1/p')
          echo "DEPLOY=$DEPLOY" >> $GITHUB_ENV

      - name: checkout code
        uses: actions/checkout@v4

      - name: create PR to deploy latest build to tenant
        if: env.DEPLOY != null
        uses: actions/checkout@v4
        with:
          repository: ajinkyak423/actions-poc
          path: actions-poc
          token: ${{ secrets.MY_GITHUB_ACTION_TOKEN }}

      - name: directory  
        run: |
            echo "Current directory: $(pwd)"
            ls -ltra
            cd ./actions-poc
            # python temp.py
            # echo "deploy_tanent_file: ${{ env.deploy_tanent_file }}"

    
      - name: update file in poc
        if: env.DEPLOY != null    
        run: |
         cd ./actions-poc
         python temp.py
         echo "deploy_tanent_file: ${{ env.deploy_tanent_file }}"
         time=$(date)
         echo "time=$time" >> yourfile.txt
         cat yourfile.txt
         git status
         git checkout -B ${{ env.DEPLOY }}
         git config user.email "418982+github-actions[bot]@users.noreply.github.com"
         git config user.name "github-actions[bot]"
         echo "Adding files"
         git add ${{ env.deploy_tanent_file }}
         git -c author.name=${{ github.actor }} -c author.email=${{ github.actor }}@users.noreply.github.com commit -m "Runner version update to ${{ env.DEPLOY }}"

         git push --force --set-upstream origin ${{ env.DEPLOY }}  # Force push to the new branch

         postData='{
           "ref": "main",
           "inputs": {
             "REPOSITORY": "ajinkyak423/actions-poc",
             "REF": "${{ env.DEPLOY }}",
             "TITLE": "Runner version update to ${{ env.DEPLOY }}",
             "BODY": "${{ env.DEPLOY }}",
             "SLACK_CHANNEL": "actions-notif"
           }
         }'

         curl -X POST \
         -d "${postData}" \
         -H "Accept: application/vnd.github+json" \
         -H "Authorization: Bearer ${{ secrets.MY_GITHUB_ACTION_TOKEN }}" \
         -H "X-GitHub-Api-Version: 2022-11-28" \
         https://api.github.com/repos/ajinkyak423/actions-poc/actions/workflows/create-pr.yml/dispatches